<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IaC å·¥æˆ¿</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 24px;
        }

        .header-logo {
            flex-shrink: 0;
        }

        .header-logo img {
            height: 40px;
            width: auto;
        }

        .header-title {
            flex: 1;
            text-align: center;
            font-size: 24px;
            font-weight: 600;
            color: #1f2937;
        }

        .header-right {
            flex-shrink: 0;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
        }

        .user-details {
            display: flex;
            flex-direction: column;
        }

        .user-name {
            font-weight: 600;
            color: #1f2937;
            font-size: 14px;
        }

        .user-email {
            font-size: 12px;
            color: #6b7280;
        }

        .logout-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }

        .logout-btn:hover {
            background: #dc2626;
        }

        .workspaces-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .section-header h2 {
            font-size: 24px;
            color: #1f2937;
        }

        .new-workspace-btn {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
        }

        .new-workspace-btn:hover {
            background: #2563eb;
        }

        .workspaces-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 20px;
        }

        .workspace-card {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 20px;
            transition: box-shadow 0.2s;
        }

        .workspace-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .workspace-name {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .workspace-repo {
            font-size: 14px;
            color: #6b7280;
            margin-bottom: 16px;
            word-break: break-all;
        }

        .workspace-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            margin-bottom: 16px;
        }

        .status-building { background: #dbeafe; color: #1e40af; }
        .status-starting { background: #fef3c7; color: #92400e; }
        .status-running { background: #d1fae5; color: #065f46; }
        .status-stopping { background: #fed7aa; color: #9a3412; }
        .status-stopped { background: #f3f4f6; color: #374151; }
        .status-deleting { background: #fee2e2; color: #991b1b; }
        .status-failed { background: #fecaca; color: #7f1d1d; }

        .devcontainer-build-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 500;
            margin-bottom: 16px;
            margin-left: 8px;
        }

        .build-success { background: #d1fae5; color: #065f46; }
        .build-failed { background: #fed7aa; color: #9a3412; }
        .build-no-devcontainer { background: #e0e7ff; color: #3730a3; }

        .workspace-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #3b82f6;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
        }

        .btn-success {
            background: #10b981;
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            background: #059669;
        }

        .btn-warning {
            background: #f59e0b;
            color: white;
        }

        .btn-warning:hover:not(:disabled) {
            background: #d97706;
        }

        .btn-danger {
            background: #ef4444;
            color: white;
        }

        .btn-danger:hover:not(:disabled) {
            background: #dc2626;
        }

        .btn-info {
            background: #06b6d4;
            color: white;
        }

        .btn-info:hover:not(:disabled) {
            background: #0891b2;
        }

        .btn-secondary {
            background: #6b7280;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4b5563;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        /* Environment variable modal should be on top of workspace modal */
        #envVarModal {
            z-index: 1100;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            max-width: 500px;
            width: 90%;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 24px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #374151;
        }

        .form-group input {
            width: 100%;
            padding: 10px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-group input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .form-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state svg {
            width: 80px;
            height: 80px;
            margin-bottom: 16px;
            opacity: 0.5;
        }

        /* Responsive design for header */
        .env-var-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px solid #e5e7eb;
        }

        .env-var-item:last-child {
            border-bottom: none;
        }

        .env-var-item:hover {
            background-color: #f9fafb;
        }

        .env-var-name {
            font-family: monospace;
            font-weight: 600;
            color: #1f2937;
            flex: 1;
        }

        .env-var-actions {
            display: flex;
            gap: 8px;
        }

        .env-var-actions button {
            padding: 4px 8px;
            font-size: 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background: transparent;
            color: #6b7280;
        }

        .env-var-actions button:hover {
            background: #e5e7eb;
        }

        .env-var-actions .edit-btn:hover {
            color: #3b82f6;
        }

        .env-var-actions .delete-btn:hover {
            color: #ef4444;
        }

        .empty-env-vars {
            padding: 20px;
            text-align: center;
            color: #9ca3af;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 16px;
            }

            .header-logo {
                align-self: flex-start;
            }

            .header-title {
                text-align: left;
                width: 100%;
            }

            .header-right {
                width: 100%;
                justify-content: space-between;
            }

            .user-email {
                display: none;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-logo">
                <img src="/logo.svg" alt="Workspaces Logo">
            </div>
            <div class="header-title">IaC å·¥æˆ¿</div>
            <div class="header-right">
                <div class="user-info">
                    <img id="userAvatar" class="user-avatar" src="" alt="User Avatar">
                    <div class="user-details">
                        <div id="userName" class="user-name"></div>
                        <div id="userEmail" class="user-email"></div>
                    </div>
                </div>
                <button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
            </div>
        </div>

        <div class="workspaces-section">
            <div class="section-header">
                <h2>ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</h2>
                <button class="new-workspace-btn" onclick="showNewWorkspaceModal()">+ æ–°è¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹</button>
            </div>
            <div id="workspacesList" class="workspaces-grid"></div>
        </div>
    </div>

    <!-- Environment Variable Modal -->
    <div id="envVarModal" class="modal">
        <div class="modal-content">
            <div class="modal-header" id="envVarModalTitle">ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ </div>
            <form id="envVarForm" onsubmit="saveEnvVar(event)">
                <div class="form-group">
                    <label for="envVarName">å¤‰æ•°å</label>
                    <input type="text" id="envVarName" required 
                           pattern="[A-Z_][A-Z0-9_]*" 
                           placeholder="VARIABLE_NAME"
                           title="å¤§æ–‡å­—ã€æ•°å­—ã€ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã®ã¿ï¼ˆå…ˆé ­ã¯å¤§æ–‡å­—ã¾ãŸã¯ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ï¼‰">
                </div>
                <div class="form-group">
                    <label for="envVarValue">å€¤</label>
                    <textarea id="envVarValue" required 
                              style="width: 100%; min-height: 100px; padding: 10px; border: 1px solid #d1d5db; border-radius: 6px; font-size: 14px; font-family: monospace; resize: vertical;"
                              placeholder="variable value"></textarea>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideEnvVarModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä¿å­˜</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Workspace Environment Variables Edit Modal -->
    <div id="workspaceEnvModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header" id="workspaceEnvModalTitle">ç’°å¢ƒå¤‰æ•°ã®è¨­å®š</div>
            <div class="form-group">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label>ç’°å¢ƒå¤‰æ•°</label>
                    <button type="button" class="btn btn-primary" onclick="addWorkspaceEnvVar()" style="padding: 4px 12px; font-size: 14px;">+ å¤‰æ•°è¿½åŠ </button>
                </div>
                <div id="workspaceEnvVarsList" style="border: 1px solid #d1d5db; border-radius: 6px; max-height: 300px; overflow-y: auto;">
                    <div class="empty-env-vars">ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>
                </div>
            </div>
            <div class="form-actions">
                <button type="button" class="btn" onclick="hideWorkspaceEnvModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                <button type="button" id="workspaceEnvModalSaveBtn" class="btn btn-primary" onclick="saveWorkspaceEnvVars()" disabled>ä¿å­˜</button>
            </div>
        </div>
    </div>

    <!-- New Workspace Modal -->
    <div id="newWorkspaceModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">æ–°ã—ã„ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’ä½œæˆ</div>
            <form id="newWorkspaceForm" onsubmit="createWorkspace(event)">
                <div class="form-group">
                    <label for="workspaceName">ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹åï¼ˆãƒªãƒã‚¸ãƒˆãƒªåï¼‰</label>
                    <input type="text" id="workspaceName" list="repositoryList" required 
                           pattern="[a-zA-Z0-9_\-]+" 
                           placeholder="ãƒªãƒã‚¸ãƒˆãƒªã‚’é¸æŠã¾ãŸã¯å…¥åŠ›" 
                           title="åˆ©ç”¨å¯èƒ½ãªãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„"
                           autocomplete="off">
                    <datalist id="repositoryList">
                        <!-- Options will be populated dynamically -->
                    </datalist>
                    <small style="color: #6b7280; font-size: 12px; margin-top: 4px; display: block;">
                        çµ„ç¹”ã®åˆ©ç”¨å¯èƒ½ãªãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„
                    </small>
                </div>
                <div class="form-group">
                    <label for="envVars">ç’°å¢ƒå¤‰æ•° (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)</label>
                    <div style="margin-bottom: 12px;">
                        <button type="button" class="btn btn-secondary" onclick="showAddEnvVarModal()" style="font-size: 14px;">
                            + å¤‰æ•°è¿½åŠ 
                        </button>
                    </div>
                    <div id="envVarsList" style="border: 1px solid #d1d5db; border-radius: 6px; max-height: 200px; overflow-y: auto;">
                        <!-- Environment variables will be listed here -->
                    </div>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn" onclick="hideNewWorkspaceModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
                    <button type="submit" class="btn btn-primary">ä½œæˆ</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        let currentUser = null;
        let workspaces = [];
        let eventSource = null;
        let availableRepositories = [];
        let envVars = {}; // Store environment variables as key-value pairs
        let editingEnvVarName = null; // Track which env var is being edited
        let workspaceEnvVars = {}; // Store workspace environment variables for editing
        let initialWorkspaceEnvVars = null; // Store initial env vars to detect changes
        let editingWorkspaceId = null; // Track which workspace we're editing
        let editingWorkspaceName = null; // Track workspace name for editing

        // Load user info
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/user');
                const data = await handleAPIResponse(response);
                
                currentUser = data;
                document.getElementById('userName').textContent = data.displayName || data.username;
                document.getElementById('userEmail').textContent = data.email || '';
                document.getElementById('userAvatar').src = data.avatar || '/default-avatar.png';
            } catch (error) {
                console.error('Error loading user info:', error);
            }
        }

        // Handle API response
        async function handleAPIResponse(response) {
            if (response.status === 401) {
                alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                window.location.href = '/';
                throw new Error('Unauthorized');
            }
            if (!response.ok) {
                const error = await response.json();
                throw new Error(error.error || 'Request failed');
            }
            return await response.json();
        }

        // Connect to SSE
        function connectSSE() {
            eventSource = new EventSource('/api/workspaces/events');
            
            eventSource.onopen = (event) => {
                console.log('SSE connected');
            };
            
            eventSource.onmessage = (event) => {
                const data = JSON.parse(event.data);
                handleWorkspaceEvent(data);
            };
            
            eventSource.onerror = (error) => {
                console.error('SSE connection error, reconnecting in 5 seconds...');
                eventSource.close();
                setTimeout(connectSSE, 5000);
            };
        }

        // Handle workspace events
        function handleWorkspaceEvent(data) {
            switch (data.type) {
                case 'init':
                    workspaces = data.workspaces;
                    renderWorkspaces();
                    break;
                case 'created':
                    const createdIndex = workspaces.findIndex(w => w.id === data.workspace.id);
                    if (createdIndex >= 0) {
                        workspaces[createdIndex] = data.workspace;
                    } else {
                        workspaces.unshift(data.workspace);
                    }
                    renderWorkspaces();
                    break;
                case 'updated':
                    const index = workspaces.findIndex(w => w.id === data.workspace.id);
                    const workspace = data.workspace;
                    
                    // Check if this workspace should be shown to the current user
                    // Show if: owned by current user OR released/shared (user_id is null)
                    const isOwnedByMe = workspace.user_id === currentUser?.id;
                    const isReleased = workspace.user_id === null;
                    const shouldShow = isOwnedByMe || isReleased;
                    
                    if (index >= 0) {
                        // Workspace exists in list
                        if (shouldShow) {
                            // Update it
                            workspaces[index] = workspace;
                        } else {
                            // Remove it (acquired by another user or user no longer has access)
                            workspaces.splice(index, 1);
                        }
                    } else {
                        // Workspace doesn't exist in list
                        if (shouldShow) {
                            // Add it (newly released/shared workspace)
                            workspaces.unshift(workspace);
                        }
                    }
                    renderWorkspaces();
                    break;
                case 'deleted':
                    workspaces = workspaces.filter(w => w.id !== data.workspace.id);
                    renderWorkspaces();
                    break;
            }
        }

        // Render workspaces
        function renderWorkspaces() {
            const container = document.getElementById('workspacesList');
            
            if (workspaces.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                  d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                        </svg>
                        <p>ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“</p>
                        <p style="font-size: 14px; margin-top: 8px;">ã€Œ+ æ–°è¦ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã€ãƒœã‚¿ãƒ³ã‹ã‚‰ä½œæˆã—ã¦ãã ã•ã„</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = workspaces.map(ws => createWorkspaceCard(ws)).join('');
        }

        // Create workspace card HTML
        function createWorkspaceCard(ws) {
            const statusClass = `status-${ws.status}`;
            const statusText = getStatusText(ws.status);
            const isProcessing = ['building', 'starting', 'stopping', 'deleting'].includes(ws.status);
            const isOwned = ws.user_id !== null;
            const isReleased = ws.user_id === null;
            const isFailed = ws.status === 'failed';
            
            // Button availability based on state transition diagram
            const canOpen = ws.status === 'running' && isOwned;
            const canStop = ws.status === 'running' && isOwned;
            const canDelete = (ws.status === 'stopped' || ws.status === 'failed') && (isOwned || isReleased);
            const canAcquire = ws.status === 'stopped' && isReleased;
            const canRebuild = !isProcessing && isOwned;
            
            // Get devcontainer build status badge
            let devcontainerBuildBadge = '';
            if (ws.devcontainer_build_status) {
                const buildStatusInfo = getDevcontainerBuildStatusInfo(ws.devcontainer_build_status);
                devcontainerBuildBadge = `<span class="devcontainer-build-status ${buildStatusInfo.class}" title="${buildStatusInfo.title}">${buildStatusInfo.text}</span>`;
            }
            
            // Ownership badge
            let ownershipBadge = '';
            if (isReleased) {
                ownershipBadge = '<span class="workspace-status" style="background: #dbeafe; color: #1e40af;">å…±æœ‰</span>';
            }
            
            return `
                <div class="workspace-card ${isProcessing ? 'pulse' : ''}">
                    <div class="workspace-name">${escapeHtml(ws.name)}</div>
                    <div class="workspace-repo">${escapeHtml(ws.repo_url)}</div>
                    <div>
                        <span class="workspace-status ${statusClass}">
                            ${isProcessing ? '<span class="loading-spinner"></span> ' : ''}
                            ${statusText}
                        </span>
                        ${devcontainerBuildBadge}
                        ${ownershipBadge}
                    </div>
                    <div class="workspace-actions">
                        ${isReleased ? `
                            <button class="btn btn-success" 
                                    onclick="acquireWorkspace(${ws.id})" 
                                    ${!canAcquire ? 'disabled' : ''}>
                                å–å¾—ã—ã¦èµ·å‹•
                            </button>
                        ` : `
                            <button class="btn btn-primary" 
                                    onclick="openWorkspace('${ws.name}')" 
                                    ${!canOpen ? 'disabled' : ''}>
                                é–‹ã
                            </button>
                            <button class="btn btn-warning" 
                                    onclick="stopWorkspace(${ws.id})" 
                                    ${!canStop || isFailed ? 'disabled' : ''}>
                                è§£æ”¾
                            </button>
                        `}
                        <button class="btn btn-danger" 
                                onclick="deleteWorkspace(${ws.id})" 
                                ${!canDelete ? 'disabled' : ''}>
                            å‰Šé™¤
                        </button>
                        ${!isReleased ? `
                            <div style="width: 100%; height: 0;"></div>
                            <button class="btn btn-info" 
                                    onclick="rebuildWorkspace(${ws.id})"
                                    ${!canRebuild ? 'disabled' : ''}>
                                å†ãƒ“ãƒ«ãƒ‰
                            </button>
                            <button class="btn btn-secondary" 
                                    onclick="downloadBuildLog(${ws.id}, '${ws.name}')"
                                    ${isProcessing ? 'disabled' : ''}>
                                ãƒ­ã‚°
                            </button>
                            <button class="btn btn-secondary" 
                                    onclick="editWorkspaceEnvVars(${ws.id}, '${ws.name}')"
                                    ${isProcessing ? 'disabled' : ''}>
                                ç’°å¢ƒå¤‰æ•°
                            </button>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Get status text
        function getStatusText(status) {
            const statusMap = {
                'building': 'ãƒ“ãƒ«ãƒ‰ä¸­',
                'starting': 'èµ·å‹•ä¸­',
                'running': 'å®Ÿè¡Œä¸­',
                'stopping': 'åœæ­¢ä¸­',
                'stopped': 'åœæ­¢',
                'deleting': 'å‰Šé™¤ä¸­',
                'failed': 'å¤±æ•—'
            };
            return statusMap[status] || status;
        }

        // Get devcontainer build status info
        function getDevcontainerBuildStatusInfo(status) {
            const statusMap = {
                'success': {
                    text: 'ãƒ“ãƒ«ãƒ‰æˆåŠŸ',
                    class: 'build-success',
                    title: 'devcontainer.jsonã§ã®ãƒ“ãƒ«ãƒ‰ã«æˆåŠŸã—ã¾ã—ãŸ'
                },
                'failed': {
                    text: 'ãƒ“ãƒ«ãƒ‰å¤±æ•—',
                    class: 'build-failed',
                    title: 'devcontainer.jsonã®ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–‹ç™ºã‚³ãƒ³ãƒ†ãƒŠã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã¾ã—ãŸ'
                },
                'no_devcontainer': {
                    text: 'devcontainer.jsonãªã—',
                    class: 'build-no-devcontainer',
                    title: 'devcontainer.jsonãŒå«ã¾ã‚Œã¦ãŠã‚‰ãšã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–‹ç™ºã‚³ãƒ³ãƒ†ãƒŠã‚’ãƒ“ãƒ«ãƒ‰ã—ã¾ã—ãŸ'
                }
            };
            return statusMap[status] || { text: status, class: '', title: status };
        }

        // Escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Modal functions
        async function showNewWorkspaceModal() {
            // Fetch available repositories before showing modal
            try {
                const response = await fetch('/api/available-repositories');
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    return;
                }
                if (!response.ok) {
                    throw new Error('åˆ©ç”¨å¯èƒ½ãªãƒªãƒã‚¸ãƒˆãƒªã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                const data = await response.json();
                availableRepositories = data.repositories;
                
                // Update datalist with available repositories
                updateRepositoryDatalist();
                
                // Reset environment variables
                envVars = {};
                renderEnvVarsList();
                
                document.getElementById('newWorkspaceModal').classList.add('active');
                document.getElementById('workspaceName').focus();
            } catch (error) {
                console.error('Error fetching available repositories:', error);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        function hideNewWorkspaceModal() {
            document.getElementById('newWorkspaceModal').classList.remove('active');
            document.getElementById('newWorkspaceForm').reset();
            envVars = {};
            editingEnvVarName = null;
            renderEnvVarsList();
        }
        
        // Workspace environment variables management functions
        async function editWorkspaceEnvVars(workspaceId, workspaceName) {
            editingWorkspaceId = workspaceId;
            editingWorkspaceName = workspaceName;
            
            // Fetch current environment variables
            try {
                const response = await fetch(`/api/workspaces/${workspaceId}/env-vars`);
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    return;
                }            
                if (!response.ok) {
                    throw new Error('ç’°å¢ƒå¤‰æ•°ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                const data = await response.json();
                workspaceEnvVars = data.envVars || {};
                initialWorkspaceEnvVars = JSON.stringify(workspaceEnvVars);
                
                document.getElementById('workspaceEnvModalTitle').textContent = `ç’°å¢ƒå¤‰æ•°ã®è¨­å®š: ${workspaceName}`;
                renderWorkspaceEnvVarsList();
                document.getElementById('workspaceEnvModal').classList.add('active');
            } catch (error) {
                console.error('Error fetching env vars:', error);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        function renderWorkspaceEnvVarsList() {
            const container = document.getElementById('workspaceEnvVarsList');
            const keys = Object.keys(workspaceEnvVars);
            
            if (keys.length === 0) {
                container.innerHTML = '<div class="empty-env-vars">ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            container.innerHTML = keys.map(key => `
                <div class="env-var-item">
                    <div class="env-var-name">${escapeHtml(key)}</div>
                    <div class="env-var-actions">
                        <button type="button" class="edit-btn" onclick="editWorkspaceEnvVarItem('${escapeHtml(key)}')" title="ç·¨é›†">
                            âœï¸
                        </button>
                        <button type="button" class="delete-btn" onclick="deleteWorkspaceEnvVar('${escapeHtml(key)}')" title="å‰Šé™¤">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');

            if (initialWorkspaceEnvVars) {
                const currentWorkspaceEnvVars = JSON.stringify(workspaceEnvVars);
                if (currentWorkspaceEnvVars !== initialWorkspaceEnvVars) {
                    // There are unsaved changes
                    document.getElementById('workspaceEnvModalSaveBtn').disabled = false;
                } else {
                    document.getElementById('workspaceEnvModalSaveBtn').disabled = true;
                }
            }
        }
        
        function addWorkspaceEnvVar() {
            editingEnvVarName = null;
            document.getElementById('envVarModalTitle').textContent = 'ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ';
            document.getElementById('envVarName').value = '';
            document.getElementById('envVarName').disabled = false;
            document.getElementById('envVarValue').value = '';
            document.getElementById('envVarModal').classList.add('active');
        }
        
        function editWorkspaceEnvVarItem(name) {
            editingEnvVarName = name;
            document.getElementById('envVarModalTitle').textContent = 'ç’°å¢ƒå¤‰æ•°ã‚’ç·¨é›†';
            document.getElementById('envVarName').value = name;
            document.getElementById('envVarName').disabled = true;
            document.getElementById('envVarValue').value = workspaceEnvVars[name] || '';
            document.getElementById('envVarModal').classList.add('active');
        }
        
        function deleteWorkspaceEnvVar(name) {
            if (confirm(`ç’°å¢ƒå¤‰æ•° "${name}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete workspaceEnvVars[name];
                renderWorkspaceEnvVarsList();
            }
        }
        
        async function saveWorkspaceEnvVars() {
            try {
                // Save environment variables
                const response = await fetch(`/api/workspaces/${editingWorkspaceId}/env-vars`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ envVars: workspaceEnvVars })
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'ç’°å¢ƒå¤‰æ•°ã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // Ask user if they want to rebuild
                const shouldRebuild = confirm('ç’°å¢ƒå¤‰æ•°ã®å¤‰æ›´ã‚’åæ˜ ã™ã‚‹ãŸã‚ã«ã¯å†ãƒ“ãƒ«ãƒ‰ãŒå¿…è¦ã§ã™ã€‚å†ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ');

                // save workspaceId for rebuild after hiding modal
                const rebuildWorkspaceId = editingWorkspaceId;
                
                hideWorkspaceEnvModal();
                
                if (shouldRebuild) {
                    // Trigger rebuild
                    rebuildWorkspace(rebuildWorkspaceId, true);
                } else {
                    alert('ç’°å¢ƒå¤‰æ•°ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚æ¬¡å›ã®å†ãƒ“ãƒ«ãƒ‰æ™‚ã«åæ˜ ã•ã‚Œã¾ã™ã€‚');
                }
            } catch (error) {
                console.error('Error saving env vars:', error);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        // Environment variable management functions
        function renderEnvVarsList() {
            const container = document.getElementById('envVarsList');
            const keys = Object.keys(envVars);
            
            if (keys.length === 0) {
                container.innerHTML = '<div class="empty-env-vars">ç’°å¢ƒå¤‰æ•°ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            container.innerHTML = keys.map(key => `
                <div class="env-var-item">
                    <div class="env-var-name">${escapeHtml(key)}</div>
                    <div class="env-var-actions">
                        <button type="button" class="edit-btn" onclick="editEnvVar('${escapeHtml(key)}')" title="ç·¨é›†">
                            âœï¸
                        </button>
                        <button type="button" class="delete-btn" onclick="deleteEnvVar('${escapeHtml(key)}')" title="å‰Šé™¤">
                            ğŸ—‘ï¸
                        </button>
                    </div>
                </div>
            `).join('');
        }
        
        function showAddEnvVarModal() {
            editingEnvVarName = null;
            document.getElementById('envVarModalTitle').textContent = 'ç’°å¢ƒå¤‰æ•°ã‚’è¿½åŠ ';
            document.getElementById('envVarName').disabled = false;
            document.getElementById('envVarName').value = '';
            document.getElementById('envVarValue').value = '';
            document.getElementById('envVarModal').classList.add('active');
            document.getElementById('envVarName').focus();
        }
        
        function editEnvVar(name) {
            editingEnvVarName = name;
            document.getElementById('envVarModalTitle').textContent = 'ç’°å¢ƒå¤‰æ•°ã‚’ç·¨é›†';
            document.getElementById('envVarName').value = name;
            document.getElementById('envVarName').disabled = true;
            document.getElementById('envVarValue').value = envVars[name] || '';
            document.getElementById('envVarModal').classList.add('active');
            document.getElementById('envVarValue').focus();
        }
        
        function deleteEnvVar(name) {
            if (confirm(`ç’°å¢ƒå¤‰æ•° "${name}" ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
                delete envVars[name];
                renderEnvVarsList();
            }
        }
        
        function hideEnvVarModal() {
            document.getElementById('envVarModal').classList.remove('active');
            document.getElementById('envVarForm').reset();
            editingEnvVarName = null;
        }
        
        function saveEnvVar(event) {
            event.preventDefault();
            
            const name = document.getElementById('envVarName').value.trim();
            const value = document.getElementById('envVarValue').value;
            
            // Check if we're editing workspace env vars or new workspace env vars
            if (editingWorkspaceId !== null) {
                // Editing workspace environment variables
                if (!editingEnvVarName && workspaceEnvVars.hasOwnProperty(name)) {
                    alert(`ç’°å¢ƒå¤‰æ•° "${name}" ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚`);
                    return;
                }
                workspaceEnvVars[name] = value;
                hideEnvVarModal();
                editingEnvVarName = null;
                renderWorkspaceEnvVarsList();
            } else {
                // New workspace environment variables
                if (!editingEnvVarName && envVars.hasOwnProperty(name)) {
                    alert(`ç’°å¢ƒå¤‰æ•° "${name}" ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚`);
                    return;
                }
                envVars[name] = value;
                hideEnvVarModal();
                editingEnvVarName = null;
                renderEnvVarsList();
            }
        }
        
        // Update datalist with available repositories
        function updateRepositoryDatalist() {
            const datalist = document.getElementById('repositoryList');
            if (!datalist) {
                // Create datalist if it doesn't exist
                const newDatalist = document.createElement('datalist');
                newDatalist.id = 'repositoryList';
                document.body.appendChild(newDatalist);
            }
            
            const list = document.getElementById('repositoryList');
            list.innerHTML = '';
            
            availableRepositories.forEach(repo => {
                const option = document.createElement('option');
                option.value = repo.name;
                if (repo.description) {
                    option.textContent = `${repo.name} - ${repo.description}`;
                }
                list.appendChild(option);
            });
        }

        // Create workspace
        function createWorkspace(event) {
            event.preventDefault();
            
            const name = document.getElementById('workspaceName').value.trim();
            
            // Validate that the selected repository is available
            const isAvailable = availableRepositories.some(repo => repo.name === name);
            if (!isAvailable) {
                alert(`ãƒªãƒã‚¸ãƒˆãƒª "${name}" ã¯åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚åˆ©ç”¨å¯èƒ½ãªãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰é¸æŠã—ã¦ãã ã•ã„ã€‚`);
                return;
            }
            
            // Save envVars before closing modal (hideNewWorkspaceModal resets envVars)
            const envVarsToSend = { ...envVars };
            
            // Close dialog immediately
            hideNewWorkspaceModal();
            
            // Fire request (repoUrl is generated on server)
            fetch('/api/workspaces', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, envVars: envVarsToSend })
            })
            .then(response => {
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Workspace creation started:', data);
            })
            .catch(error => {
                console.error('Error creating workspace:', error);
                if (error.message !== 'Unauthorized') {
                    alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            });
        }

        // Open workspace
        async function openWorkspace(name) {
            try {
                // Check authentication by fetching user info
                const response = await fetch('/api/user');
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    return;
                }
                if (!response.ok) {
                    throw new Error('èªè¨¼ã®ç¢ºèªã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // Authentication confirmed, open workspace
                window.open(`/${currentUser.username}/workspaces/${name}/?folder=/workspaces/${name}`, '_blank');
            } catch (error) {
                console.error('Error opening workspace:', error);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }

        // Start workspace
        function startWorkspace(id) {
            fetch(`/api/workspaces/${id}/start`, {
                method: 'POST'
            })
            .then(response => {
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'èµ·å‹•ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Workspace start initiated:', data);
            })
            .catch(error => {
                if (error.message !== 'Unauthorized') {
                    console.error('Error starting workspace:', error);
                }
            });
        }

        // Stop workspace (release)
        function stopWorkspace(id) {
            if (!confirm('ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’åœæ­¢ã—ã¦è§£æ”¾ã—ã¾ã™ã‹ï¼Ÿåœæ­¢å¾Œã¯ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒåˆ©ç”¨ã§ãã‚‹ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚')) {
                return;
            }
            
            fetch(`/api/workspaces/${id}/stop`, {
                method: 'POST'
            })
            .then(response => {
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'åœæ­¢ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Workspace stop initiated:', data);
            })
            .catch(error => {
                if (error.message !== 'Unauthorized') {
                    console.error('Error stopping workspace:', error);
                }
            });
        }

        // Acquire workspace (automatically starts)
        function acquireWorkspace(id) {
            fetch(`/api/workspaces/${id}/acquire`, {
                method: 'POST'
            })
            .then(response => {
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Workspace acquired and starting:', data);
            })
            .catch(error => {
                if (error.message !== 'Unauthorized') {
                    console.error('Error acquiring workspace:', error);
                    alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            });
        }

        // Delete workspace
        function deleteWorkspace(id) {
            if (!confirm('æœ¬å½“ã«ã“ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            fetch(`/api/workspaces/${id}`, {
                method: 'DELETE'
            })
            .then(response => {
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Workspace deletion initiated:', data);
            })
            .catch(error => {
                if (error.message !== 'Unauthorized') {
                    console.error('Error deleting workspace:', error);
                }
            });
        }

        // Rebuild workspace
        function rebuildWorkspace(id, confirmRebuild = false) {
            if (!confirmRebuild && !confirm('ã“ã®ãƒ¯ãƒ¼ã‚¯ã‚¹ãƒšãƒ¼ã‚¹ã‚’å†ãƒ“ãƒ«ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            fetch(`/api/workspaces/${id}/rebuild`, {
                method: 'POST'
            })
            .then(response => {
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    throw new Error('Unauthorized');
                }
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.error || 'å†ãƒ“ãƒ«ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                    });
                }
                return response.json();
            })
            .then(data => {
                console.log('Workspace rebuild initiated:', data);
            })
            .catch(error => {
                if (error.message !== 'Unauthorized') {
                    console.error('Error rebuilding workspace:', error);
                    alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
                }
            });
        }

        // Download build log
        async function downloadBuildLog(id, name) {
            try {
                // Check authentication and file availability with HEAD request
                const response = await fetch(`/api/workspaces/${id}/build-log`, {
                    method: 'HEAD'
                });
                
                if (response.status === 401) {
                    alert('ã‚»ãƒƒã‚·ãƒ§ãƒ³ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚ãƒ­ã‚°ã‚¤ãƒ³ã—ç›´ã—ã¦ãã ã•ã„');
                    window.location.href = '/';
                    return;
                }
                
                if (response.status === 404) {
                    alert('ãƒ“ãƒ«ãƒ‰ãƒ­ã‚°ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                if (!response.ok) {
                    throw new Error('ãƒ­ã‚°ã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
                
                // Authentication and file confirmed, open download
                window.open(`/api/workspaces/${id}/build-log`, '_blank');
            } catch (error) {
                console.error('Error downloading build log:', error);
                alert('ã‚¨ãƒ©ãƒ¼: ' + error.message);
            }
        }
        
        function hideWorkspaceEnvModal() {
            document.getElementById('workspaceEnvModal').classList.remove('active');
            workspaceEnvVars = {};
            editingWorkspaceId = null;
            editingWorkspaceName = null;
            editingEnvVarName = null;
            initialWorkspaceEnvVars = null;
        }

        // Logout
        function logout() {
            if (eventSource) {
                eventSource.close();
            }
            window.location.href = '/logout';
        }

        // Initialize
        window.addEventListener('DOMContentLoaded', () => {
            loadUserInfo();
            connectSSE();
        });

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (eventSource) {
                eventSource.close();
            }
        });
    </script>
</body>
<!-- Version: 2025-11-06-08:40 -->
</html>
